<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกประวัติผู้ป่วยและการรักษา</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 1000px;
            margin: auto;
            overflow: hidden;
            padding: 0 20px;
        }
        h1, h2, h3 {
            color: #333;
        }
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
        }
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
        }
        .tab button:hover {
            background-color: #ddd;
        }
        .tab button.active {
            background-color: #ccc;
        }
        .tabcontent {
            display: none;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-top: none;
        }
        input[type="text"], input[type="date"], input[type="number"], textarea, select {
            width: 100%;
            padding: 8px;
            margin: 5px 0 22px 0;
            display: inline-block;
            border: none;
            background: #f1f1f1;
        }
        input[type="submit"] {
            background-color: #4CAF50;
            color: white;
            padding: 14px 20px;
            margin: 8px 0;
            border: none;
            cursor: pointer;
            width: 100%;
        }
        input[type="submit"]:hover {
            opacity: 0.8;
        }
        .search-results {
            position: absolute;
            background-color: #f9f9f9;
            min-width: 230px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
        }
        .search-results div {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }
        .search-results div:hover {
            background-color: #f1f1f1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ระบบบันทึกประวัติผู้ป่วยและการรักษา</h1>
        
        <div class="tab">
            <button class="tablinks" onclick="openTab(event, 'PatientInfo')" id="defaultOpen">ข้อมูลผู้ป่วย</button>
            <button class="tablinks" onclick="openTab(event, 'TreatmentRecord')">บันทึกการรักษา</button>
        </div>

        <div id="PatientInfo" class="tabcontent">
            <h2>บันทึกข้อมูลผู้ป่วย</h2>
            <form id="patientForm">
                <label for="name">ชื่อ-นามสกุล:</label>
                <input type="text" id="name" name="name" required>

                <label for="dob">วันเกิด:</label>
                <input type="date" id="dob" name="dob" required>

                <label for="age">อายุ:</label>
                <input type="number" id="age" name="age" required>

                <label for="occupation">อาชีพ:</label>
                <input type="text" id="occupation" name="occupation">

                <label for="address">ที่อยู่:</label>
                <textarea id="address" name="address"></textarea>

                <label for="phone">เบอร์โทรศัพท์:</label>
                <input type="text" id="phone" name="phone">

                <label for="underlying">โรคประจำตัว:</label>
                <textarea id="underlying" name="underlying"></textarea>

                <label for="allergy">ประวัติการแพ้ยา:</label>
                <textarea id="allergy" name="allergy"></textarea>

                <input type="submit" value="บันทึกข้อมูล">
            </form>

            <h3>รายชื่อผู้ป่วย</h3>
            <ul id="patientList"></ul>
        </div>

        <div id="TreatmentRecord" class="tabcontent">
            <h2>บันทึกการรักษา</h2>
            <input type="text" id="searchPatient" placeholder="ค้นหาผู้ป่วย (ชื่อ หรือ HN)">
            <div id="searchResults" class="search-results"></div>
            <div id="selectedPatient"></div>
            <form id="treatmentForm">
                <label for="visitDate">วันที่รักษา:</label>
                <input type="date" id="visitDate" name="visitDate" required>

                <label for="symptoms">อาการ:</label>
                <textarea id="symptoms" name="symptoms" required></textarea>

                <label for="diagnosis">การวินิจฉัย:</label>
                <textarea id="diagnosis" name="diagnosis" required></textarea>

                <label for="treatment">การรักษา:</label>
                <textarea id="treatment" name="treatment" required></textarea>

                <label for="medication">ยาที่ได้รับ:</label>
                <input type="text" id="medication" name="medication">

                <label for="nextAppointment">วันนัดครั้งต่อไป:</label>
                <input type="date" id="nextAppointment" name="nextAppointment">

                <input type="submit" value="บันทึกการรักษา">
            </form>

            <h3>ประวัติการรักษา</h3>
            <div id="treatmentHistory"></div>
        </div>
    </div>

    <script>
        let patients = JSON.parse(localStorage.getItem('patients')) || [];
        let currentHN = parseInt(localStorage.getItem('currentHN') || '0');

        function generateHN() {
            currentHN++;
            return 'HN' + currentHN.toString().padStart(6, '0');
        }

        function saveData() {
            localStorage.setItem('patients', JSON.stringify(patients));
            localStorage.setItem('currentHN', currentHN.toString());
        }

        function updatePatientList() {
            const patientList = document.getElementById('patientList');
            patientList.innerHTML = '';
            patients.forEach(patient => {
                const li = document.createElement('li');
                li.textContent = `${patient.name} (HN: ${patient.hn})`;
                patientList.appendChild(li);
            });
        }

        document.getElementById('patientForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const newPatient = {
                hn: generateHN(),
                name: document.getElementById('name').value,
                dob: document.getElementById('dob').value,
                age: document.getElementById('age').value,
                occupation: document.getElementById('occupation').value,
                address: document.getElementById('address').value,
                phone: document.getElementById('phone').value,
                underlying: document.getElementById('underlying').value,
                allergy: document.getElementById('allergy').value,
                treatments: []
            };
            patients.push(newPatient);
            saveData();
            updatePatientList();
            this.reset();
            alert('บันทึกข้อมูลผู้ป่วยเรียบร้อยแล้ว');
        });

        document.getElementById('searchPatient').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = '';
            const filteredPatients = patients.filter(patient => 
                patient.name.toLowerCase().includes(searchTerm) || 
                patient.hn.toLowerCase().includes(searchTerm)
            );
            filteredPatients.forEach(patient => {
                const div = document.createElement('div');
                div.textContent = `${patient.name} (HN: ${patient.hn})`;
                div.onclick = function() {
                    document.getElementById('searchPatient').value = this.textContent;
                    searchResults.innerHTML = '';
                    displayPatientInfo(patient);
                };
                searchResults.appendChild(div);
            });
        });

        function displayPatientInfo(patient) {
            const selectedPatient = document.getElementById('selectedPatient');
            selectedPatient.innerHTML = `
                <h3>ข้อมูลผู้ป่วย</h3>
                <p><strong>ชื่อ-นามสกุล:</strong> ${patient.name}</p>
                <p><strong>HN:</strong> ${patient.hn}</p>
                <p><strong>วันเกิด:</strong> ${patient.dob}</p>
                <p><strong>อายุ:</strong> ${patient.age}</p>
                <p><strong>อาชีพ:</strong> ${patient.occupation}</p>
                <p><strong>ที่อยู่:</strong> ${patient.address}</p>
                <p><strong>เบอร์โทรศัพท์:</strong> ${patient.phone}</p>
                <p><strong>โรคประจำตัว:</strong> ${patient.underlying}</p>
                <p><strong>ประวัติการแพ้ยา:</strong> ${patient.allergy}</p>
            `;
            displayTreatmentHistory(patient);
        }

        document.getElementById('treatmentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const patientHN = document.getElementById('searchPatient').value.split('HN: ')[1];
            const patientIndex = patients.findIndex(p => p.hn === patientHN);
            if (patientIndex === -1) {
                alert('กรุณาเลือกผู้ป่วยก่อนบันทึกการรักษา');
                return;
            }
            const newTreatment = {
                date: document.getElementById('visitDate').value,
                symptoms: document.getElementById('symptoms').value,
                diagnosis: document.getElementById('diagnosis').value,
                treatment: document.getElementById('treatment').value,
                medication: document.getElementById('medication').value,
                nextAppointment: document.getElementById('nextAppointment').value
            };
            patients[patientIndex].treatments.unshift(newTreatment);
            saveData();
            displayTreatmentHistory(patients[patientIndex]);
            this.reset();
            alert('บันทึกการรักษาเรียบร้อยแล้ว');
        });

        function displayTreatmentHistory(patient) {
            const treatmentHistory = document.getElementById('treatmentHistory');
            treatmentHistory.innerHTML = '';
            patient.treatments.forEach((treatment, index) => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <h4>การรักษาครั้งที่ ${index + 1} (${treatment.date})</h4>
                    <p><strong>อาการ:</strong> ${treatment.symptoms}</p>
                    <p><strong>การวินิจฉัย:</strong> ${treatment.diagnosis}</p>
                    <p><strong>การรักษา:</strong> ${treatment.treatment}</p>
                    <p><strong>ยาที่ได้รับ:</strong> ${treatment.medication}</p>
                    <p><strong>วันนัดครั้งต่อไป:</strong> ${treatment.nextAppointment}</p>
                `;
                treatmentHistory.appendChild(div);
            });
        }
        document.getElementById('bodyChartUpload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('bodyChartPreview');
            preview.src = e.target.result;
            preview.style.display = 'block';
        }
        reader.readAsDataURL(file);
    }
});

        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        // เปิดแท็บ "ข้อมูลผู้ป่วย" เป็นค่าเริ่มต้น
        document.getElementById("defaultOpen").click();

        // โหลดข้อมูลผู้ป่วยเมื่อเริ่มต้น
        updatePatientList();
    </script>
</body>
</html>
